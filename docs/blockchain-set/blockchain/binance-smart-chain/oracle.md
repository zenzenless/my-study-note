# 预言机 Oracle

### 什么是 `oracle`

> `oracle` 翻译是预言机，英文中的意思是预卜先知，知晓消息的意思。在区块链里用于合约获取链外的数据。

BSC => BC 跨链交易：

![](oracle_relayer.assets/relay_workflow.drawio.svg)

### 位于`Beacon Chain` 上的跨链相关模块

​	位于`Beacon Chain`上的`oracle`模块，可类比成以太坊上的合约。

#### Oracle 模块

`Oracle 模块` 用于处理 **预言（Prophecy）** 和 **声明（Claim）**，Prophecy 的意思是验证者们需要对某些事情上达成共识（例如跨链交易等）。在跨链交易中，验证者各自提出自己的`claim`，`claim`内容就是跨链交易的明细，（换句话说，就是验证者各自声明自己在`BSC`链上看到了哪些跨链交易）；当大多数验证者（如70%）在`预言`上声明了相同的内容时，获胜的内容将被确认。每种类型的声明都有其序列号，当声明被确认时，序列号就+1。

##### Oracle 处理流程

![](oracle_relayer.assets/oracle_module.drawio.svg)

1. Oracle 模块从验证者接收到声明消息，如果序列不是当前序列，则声明消息将被拒绝。
2. 如果序列有效，则将检查声明消息，如果声明消息无效，则返回
3. 如果声明消息有效并且是第一个声明，则将创建相关的预言。如果声明消息不是第一个声明，则将其添加到已存在的预言中。
4. 如果声明相同内容的验证者的权力达到 70% 这样的阈值，则预言将被标记为成功，将执行获胜的声明，并且声明类型的顺序将增加。
5. 如果验证者没有机会达成共识，则预言将被标记为失败，预言将被删除，验证者应重新开始。

#### bridge 模块

桥接模块将处理跨链交易。它包含两部分：从 `BC` 到 `BSC` 的交易和从 `BSC` 到 `BC` 的交易。对于从 `BSC` 到 `BC` 的交易，它将取决于 oracle 模块。当验证者对某个声明达成共识时，桥接模块将根据该声明处理交易，如从 BSC 到 BC 的代币转移。对于从 BC 到 BSC 的交易，它会处理交易的 BC 部分，并为 BSC 编写相关的跨链数据包。



## 中继器

​	中继器`oracle-relayer`是一个独立的二进制程序，它监听 BSC 上的事件，构建事务并将其广播到 BC。每个验证者都应该维护自己的中继器，并且中继器需要能够访问验证者的私钥。所有中继器服务独立见证`BSC`上的跨链合约事件，然后构建交易以向 BC `oracle`模块声明事件。





### 中继过程

![中继流程](oracle_relayer.assets/relay.svg)

1. 持续监听跨链事件：

中继器持续监听BSC链上`CrossChain`合约的事件，将跨链数据保存到数据库

![image-20220415135104674](oracle_relayer.assets/image-20220415135104674.png)

![image-20220415140122871](oracle_relayer.assets/image-20220415140122871.png)

2. 从`BC`链上获取`sequence`等参数

3. 根据`sequence`参数从数据库获取要声明的交易

4. 将数据包放在`claim`消息里，发送给`BC`链中的`oracle`模块：

   声明的内容：
   
   ![image-20220415143517957](oracle_relayer.assets/image-20220415143517957.png)

`claim`消息结构:

![image-20220415165254684](oracle_relayer.assets/image-20220415165254684.png)

